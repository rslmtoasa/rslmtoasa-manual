.. _examples/bulk_si:

====================================
Bulk Silicon (Diamond Structure)
====================================

**Location:** ``example/bulk/Si/``

**System:** Non-magnetic diamond cubic silicon

**Physics:** Demonstrates basic SCF convergence for a simple semiconductor with covalent bonding.

Overview
========

Silicon crystallizes in the diamond cubic structure (FCC with 2-atom basis). This example shows how to set up a periodic bulk calculation with the RS-LMTO-ASA method. The calculation uses:

- ``pre_processing = 'bravais'`` to generate the crystal structure
- ``crystal_sym = 'file'`` to read structure from ``lattice.nml``
- Periodic boundary conditions (PBC) in all directions
- Scalar relativistic treatment (``nsp = 2``)

Files
=====

The example directory contains:

- ``input.nml`` - Main calculation parameters
- ``lattice.nml`` - Crystal structure (auto-generated by pre_processing)
- ``Si1.nml`` - Tight-binding parameters for first Si atom
- ``Si2.nml`` - Tight-binding parameters for second Si atom

Input File: input.nml
=====================

The main input file specifies all calculation parameters:

.. code-block:: fortran

   &calculation
   pre_processing = 'bravais'    ! Generate Bravais lattice
   verbose = T                   ! Print detailed output
   /
   
   &lattice
   rc = 50                       ! Cluster radius (a.u.)
   alat = 5.443702               ! Lattice constant (Å)
   crystal_sym = 'file'          ! Read structure from lattice.nml
   wav = 1.4962757958            ! Wigner-Seitz radius parameter
   pbc = .true.                  ! Use periodic boundary conditions
   b1 = .true.                   ! PBC along lattice vector a1
   b2 = .true.                   ! PBC along lattice vector a2
   b3 = .true.                   ! PBC along lattice vector a3
   n1 = 20                       ! k-mesh for DOS (Brillouin zone)
   n2 = 20
   n3 = 20
   ntype = 2                     ! Number of atom types
   ct(:) = 2*4.0d0               ! Charge transfer (4e⁻ per Si)
   r2 = 16.0d0                   ! Screening radius (a.u.)
   /
   
   &atoms
   database = './'               ! Atom parameters in current directory
   label(1) = 'Si1'              ! First Si atom in basis
   label(2) = 'Si2'              ! Second Si atom in basis
   /
   
   &self
   nstep = 25                    ! Maximum SCF iterations
   cold = .true.                 ! Cold start (no restart)
   /
   
   &energy
   fermi = -0.168353             ! Initial Fermi energy (Ry)
   energy_min = -1.5             ! Energy window minimum (Ry)
   energy_max = 1.0              ! Energy window maximum (Ry)
   channels_ldos = 2000          ! Energy points for DOS
   /
   
   &control
   calctype = 'B'                ! Bulk calculation
   nsp = 2                       ! Spin-polarized formalism
   lld = 250                     ! Recursion levels
   recur = 'chebyshev'           ! Chebyshev recursion method
   /
   
   &mix
   beta = 0.1                    ! Mixing parameter (conservative)
   mixtype = 'broyden'           ! Broyden mixing scheme
   /
   
   &hamiltonian
   hoh = .false.                 ! No higher-order hopping
   /

Key Parameters Explained
------------------------

**Lattice Parameters:**

- ``rc = 50``: Cluster radius in atomic units. Should include 5-10 neighbor shells. For Si with alat ≈ 5.44 Å ≈ 10.3 a.u., rc=50 includes neighbors up to ~5 lattice constants.

- ``alat = 5.443702``: Experimental lattice constant of Si at room temperature in Ångströms.

- ``crystal_sym = 'file'``: Instructs code to read full crystal structure from ``lattice.nml``. Alternative options: 'fcc', 'bcc', 'sc', etc. for standard lattices.

- ``wav = 1.4962757958``: Wigner-Seitz radius parameter. Related to atomic sphere radius by: r_WS = wav × alat / 2.

- ``pbc = .true.`` with ``b1 = b2 = b3 = .true.``: Enables 3D periodic boundary conditions (essential for bulk calculations).

- ``n1 = n2 = n3 = 20``: k-point mesh (20×20×20) for Brillouin zone integration when calculating DOS.

- ``ntype = 2``: Two inequivalent Si atoms in diamond structure.

- ``ct(:) = 2*4.0d0``: Initial charge transfer guess (4 valence electrons per Si atom).

- ``r2 = 16.0``: Screening radius for electrostatic interactions.

**SCF Parameters:**

- ``nstep = 25``: Maximum number of SCF iterations. Si typically converges in 10-15 iterations.

- ``cold = .true.``: Start from scratch (no restart from previous calculation).

**Energy Parameters:**

- ``fermi = -0.168353``: Initial guess for Fermi energy. Will be updated during SCF.

- ``energy_min/max``: Energy window for Green's function calculation. Should bracket all valence states.

- ``channels_ldos = 2000``: Number of energy points for DOS. More points → smoother DOS.

**Control Parameters:**

- ``calctype = 'B'``: **Bulk** calculation type. Other options: 'S' (surface), 'I' (impurity).

- ``nsp = 2``: Spin-polarized formalism. Even for non-magnetic systems, use nsp=2 to allow spin polarization if needed.

- ``lld = 250``: Number of recursion levels. Higher → better convergence but slower.

- ``recur = 'chebyshev'``: Use Chebyshev recursion (Kernel Polynomial Method). Alternative: 'block'.

**Mixing Parameters:**

- ``beta = 0.1``: Mixing parameter for SCF convergence. Lower values (0.01-0.1) → more stable but slower. Higher values (0.3-0.5) → faster but may oscillate.

- ``mixtype = 'broyden'``: Broyden mixing for accelerated convergence.

Lattice File: lattice.nml
==========================

The ``lattice.nml`` file defines the crystal structure. It is auto-generated when running with ``pre_processing = 'bravais'``:

.. code-block:: fortran

   &lattice
   nbulk_bulk = 2                ! Number of bulk atoms
   ntot = 2                      ! Total number of atoms in unit cell
   nbas = 2                      ! Number of basis atoms
   nrec = 2                      ! Number of recursive atoms
   
   ! Lattice vectors (FCC, fractional coordinates)
   a(:, 1) = 0.5, 0.5, 0.0       ! First lattice vector
   a(:, 2) = 0.5, 0.0, 0.5       ! Second lattice vector
   a(:, 3) = 0.0, 0.5, 0.5       ! Third lattice vector
   
   ! Atomic positions (fractional coordinates)
   crd(:, 1) = 0.0, 0.0, 0.0     ! Si1 at origin
   crd(:, 2) = 0.25, 0.25, 0.25  ! Si2 at (1/4, 1/4, 1/4)
   
   ! Atom type indices
   izp(1) = 1                    ! Atom 1 is type 1 (Si1)
   izp(2) = 2                    ! Atom 2 is type 2 (Si2)
   
   ! Atom numbering
   no(1) = 1
   no(2) = 2
   
   ! Unique atom indices (for symmetry)
   iu(1) = 1
   iu(2) = 2
   
   ! Basis indices
   ib(1) = 1
   ib(2) = 2
   
   ! Recursion indices
   irec(1) = 1
   irec(2) = 2
   /

Structure Explanation
---------------------

**Diamond Structure:**

- Diamond = FCC lattice with 2-atom basis
- Basis atoms at (0,0,0) and (1/4,1/4,1/4)
- Each Si has 4 nearest neighbors in tetrahedral coordination
- Nearest neighbor distance: a√3/4 ≈ 2.35 Å

**Lattice Vectors:**

The three vectors define an FCC unit cell:

.. code-block:: text

   a₁ = (a/2, a/2, 0)
   a₂ = (a/2, 0, a/2)
   a₃ = (0, a/2, a/2)

These are fractional coordinates; multiply by ``alat`` to get Cartesian coordinates.

**Atomic Positions:**

.. code-block:: text

   Si1: (0, 0, 0)           - at cube corner
   Si2: (a/4, a/4, a/4)     - at body center

Atom Parameters: Si1.nml
=========================

Each atom type requires a separate namelist file with tight-binding parameters:

.. code-block:: fortran

   &element
   symbol = 'Si1'                ! Atom label
   atomic_number = 14            ! Z = 14 for silicon
   core = 10                     ! [Ne] core: 10 electrons
   valence = 4                   ! 3s²3p² valence electrons
   f_core = 0                    ! No f-electrons in core
   num_quant_s = 3               ! Principal quantum number for s
   num_quant_p = 3               ! Principal quantum number for p
   num_quant_d = 3               ! Principal quantum number for d
   /
   
   &par
   lmax = 2                      ! Include up to d orbitals (l=0,1,2)
   
   ! Potential parameters (spin-up, spin-down)
   pl(:, 1) = 3.6773887847, 3.5489819892, 3.0000000000
   pl(:, 2) = 3.6773887847, 3.5489819892, 3.0000000000
   
   ! Band center energies (Ry)
   center_band(:, 1) = -0.437959486, -0.005626491, -0.149999999
   center_band(:, 2) = -0.437959486, -0.005626491, -0.149999999
   
   ! Band widths (Ry)
   width_band(:, 1) = 0.277419344, 0.158946531, 0.100000000
   width_band(:, 2) = 0.277419344, 0.158946531, 0.100000000
   
   ! Charge moments Q₀ (s, p, d channels, spin-up/down)
   ql(1, :, 1) = 0.3939099695, 0.9918099831, 0.0000000000
   ql(1, :, 2) = 0.3939099695, 0.9918099831, 0.0000000000
   
   ! Higher charge moments Q₂
   ql(3, :, 1) = 0.0067346054, 0.0133577803, 0.0000000000
   ql(3, :, 2) = 0.0067346054, 0.0133577803, 0.0000000000
   
   ! Wigner-Seitz radius (a.u.)
   ws_r = 2.773700
   
   ! Energy contributions (Ry)
   sumec = -289.41619933
   sumev = 0.13481086
   etot = -579.43732968
   utot = -0.27082027
   ekin = 0.43286922
   /

Parameters Explained
--------------------

**Element Block:**

- ``core = 10``: Si has [Ne] = 1s²2s²2p⁶ core (10 electrons). These are frozen in the calculation.

- ``valence = 4``: Si has 4 valence electrons (3s²3p²) that participate in bonding.

**Tight-Binding Parameters:**

- ``pl(:, spin)``: Potential parameters for each orbital (s, p, d). Related to radial extent of atomic orbitals.

- ``center_band``: Energy center of each orbital band. Note s and p have negative energies (bound states).

- ``width_band``: Width of each orbital band. Related to hopping strength.

- ``ql(1, :, spin)``: Charge moments (Q₀). Sum should equal valence charge: 0.394 + 0.992 ≈ 1.386 e⁻ per spin → total ≈ 2.77 e⁻ (note: this is per orbital symmetry, not total).

**Wigner-Seitz Radius:**

- ``ws_r = 2.773700``: Atomic sphere radius in a.u. For Si with alat = 5.44 Å, this gives r_WS ≈ 1.47 Å.

**Si2.nml:** The second Si atom (Si2.nml) has identical parameters to Si1.nml because both are Si atoms in equivalent chemical environments (diamond symmetry).

Running the Calculation
========================

Step 1: Navigate to Example Directory
--------------------------------------

.. code-block:: bash

   cd example/bulk/Si

Step 2: Run the Calculation
----------------------------

The code reads ``input.nml`` from the current directory by default:

.. code-block:: bash

   ../../../build/bin/rslmto.x

**Alternative:** Redirect output to a log file:

.. code-block:: bash

   ../../../build/bin/rslmto.x > si_scf.log 2>&1

Step 3: Monitor Progress
-------------------------

During execution, the code prints SCF iteration information:

.. code-block:: text

   Iteration   1: Fermi = -0.168353  Charge = 8.01234
   Iteration   2: Fermi = -0.169122  Charge = 7.99876
   Iteration   3: Fermi = -0.168901  Charge = 8.00034
   ...
   Iteration  12: Fermi = -0.168456  Charge = 8.00001
   
   SCF converged in 12 iterations

**Convergence indicators:**

- Fermi energy stabilizes (varies by < 0.001 Ry)
- Total charge equals expected value (8 electrons = 4 per Si × 2 atoms)
- Energy components stop changing

Expected Output
===============

Output Files
------------

After successful completion, the following files are created:

- ``input_out.nml`` - Updated input parameters with converged values
- ``Si1_out.nml`` - Converged tight-binding parameters for Si1
- ``Si2_out.nml`` - Converged tight-binding parameters for Si2
- ``dos.dat`` - Density of states (if requested)
- ``bands.dat`` - Band structure (if requested)

Convergence Metrics
-------------------

**Check Fermi energy:**

.. code-block:: bash

   grep "fermi" input_out.nml

Expected: fermi ≈ -0.168 ± 0.005 Ry

**Check total charge:**

.. code-block:: bash

   grep "Total charge" Si1_out.nml
   grep "Total charge" Si2_out.nml

Expected: Each Si should have ~4 valence electrons.

**Check SCF convergence:**

.. code-block:: bash

   tail -20 input_out.nml

The last few iterations should show stable Fermi energy and charge.

Physical Results
----------------

**Band Gap:**

Si is a semiconductor with an indirect band gap of ~1.1 eV (experimental). The LMTO-ASA typically reproduces this within ~10-20%.

**Density of States:**

If you plot ``dos.dat``, you should see:

- Deep minimum (band gap) near Fermi energy
- Valence band maximum below Fermi level
- Conduction band minimum above Fermi level

**Total Energy:**

.. code-block:: bash

   grep "etot" Si1_out.nml

Typical values: etot ≈ -579 Ry per Si atom.

Performance
-----------

**Expected runtime:** 20-40 seconds on a single CPU core.

**Memory usage:** ~50-100 MB.

**Parallelization:** Use OpenMP for faster execution:

.. code-block:: bash

   export OMP_NUM_THREADS=4
   ../../../build/bin/rslmto.x

Troubleshooting
===============

SCF Not Converging
------------------

If the calculation doesn't converge in 25 iterations:

1. **Reduce mixing parameter:**

   .. code-block:: fortran
   
      beta = 0.05    ! Instead of 0.1

2. **Increase iteration limit:**

   .. code-block:: fortran
   
      nstep = 50

3. **Check cluster size:** Ensure ``rc`` is large enough (at least 40 a.u. for Si).

Wrong Total Charge
------------------

If total charge deviates significantly from 8 electrons:

1. **Adjust charge transfer parameter:**

   .. code-block:: fortran
   
      ct(:) = 2*3.5d0    ! Try different values

2. **Increase cluster radius:**

   .. code-block:: fortran
   
      rc = 60

3. **Check atom parameters:** Verify Si1.nml and Si2.nml have correct ``valence = 4``.

Slow Convergence
----------------

To speed up the calculation:

1. **Reduce recursion levels:**

   .. code-block:: fortran
   
      lld = 150    ! Instead of 250

2. **Reduce energy points:**

   .. code-block:: fortran
   
      channels_ldos = 1000

3. **Use OpenMP:** Set ``OMP_NUM_THREADS`` environment variable.

Extensions
==========

Calculating Band Structure
---------------------------

To calculate bands along high-symmetry directions, add to ``&control``:

.. code-block:: fortran

   &control
   calctype = 'B'
   calc_bands = .true.
   /

Calculating Density of States
------------------------------

DOS is calculated by default if ``channels_ldos > 0``. Increase for smoother DOS:

.. code-block:: fortran

   channels_ldos = 5000    ! Very smooth DOS

Pressure/Volume Study
---------------------

Vary ``alat`` to study pressure dependence:

.. code-block:: bash

   for alat in 5.30 5.35 5.40 5.45 5.50; do
       sed "s/alat = .*/alat = $alat/" input.nml > input_$alat.nml
       ../../../build/bin/rslmto.x input_$alat.nml
       grep "etot" Si1_out.nml >> energy_vs_volume.dat
   done

Then fit E(V) to Birch-Murnaghan equation of state to extract bulk modulus.

See Also
========

- :doc:`bulk_bccfe` - Magnetic bulk system
- :doc:`bulk_mn3sn` - Non-collinear magnetism
- :doc:`../input_files` - Complete input file reference
- :doc:`../../keywords/index` - All input keywords
- :doc:`../../theory/lmto_asa_overview` - LMTO theory background